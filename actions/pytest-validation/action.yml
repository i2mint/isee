name: "Pytest Validation"
description: "Validate source code running pytest"
inputs:
  root-dir:
    description: "Root directory to validate. Defaults to the current directory."
    required: false
    default: "."
  paths-to-ignore:
    description: "Folders and or files to ignore. Provide a comma separated list of 
      paths from the current directory. Any file under these paths will be ignored. 
      Example: 'examples,core/scrap,setup.py'"
    required: false
  skip-doctests:
    description: "Skip doctests"
    required: false
  pytest-args:
    description: "Additional arguments to pass to pytest"
    required: false
    default: "-v"
runs:
  using: 'composite'
  steps:
    - name: Install Dependencies
      uses: i2mint/isee/actions/install-packages@master
      with:
        pypi-packages: 'pytest'
    - name: Validate Source Code
      shell: bash
      run: |
        set -e
        options="${{ inputs.pytest-args }}"
        
        # Create norecursedirs argument to completely skip directories
        norecursedirs=""
        if [ -n "${{ inputs.paths-to-ignore }}" ]; then
          IFS=',' read -ra paths <<< "${{ inputs.paths-to-ignore }}"
          for path in "${paths[@]}"
          do
              # Add both --ignore and to norecursedirs
              options+=" --ignore=${{ inputs.root-dir }}/$path"
              
              # Build up norecursedirs list (space-separated)
              if [ -z "$norecursedirs" ]; then
                norecursedirs="$path"
              else
                norecursedirs="$norecursedirs $path"
              fi
          done
          
          # If we have directories to skip, add the norecursedirs option
          if [ -n "$norecursedirs" ]; then
            options+=" --norecursedirs=$norecursedirs"
          fi
        fi
        
        if [ "${{ inputs.skip-doctests }}" != "true" ]; then
          options+=" --doctest-modules"
        fi
        
        # Add confcutdir option to ignore conftest.py files in ignored directories
        options+=" --confcutdir=${{ inputs.root-dir }}"
        
        # Create a pytest.ini file to add more exclude patterns
        if [ -n "${{ inputs.paths-to-ignore }}" ]; then
          echo "Creating temporary pytest configuration..."
          echo "[pytest]" > pytest.ini
          echo "python_files = *.py" >> pytest.ini
          echo "addopts = --ignore-glob=\"**/_resources/**\"" >> pytest.ini
          cat pytest.ini
        fi
        
        echo "Running: pytest $options ${{ inputs.root-dir }}"
        pytest $options ${{ inputs.root-dir }}
